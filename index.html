<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mythical Collection Tracker</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <header>
    <h1>Mythical Collection Tracker</h1><br>
    <p>Welcome! This is a barebones (and also still very much in progress) site that will let you keep track of your
      Mythical collectibles. Each major group of collectibles has its own page. The checklist states are stored in your
      browser, so unless you explicitly clear your browser data in settings, your checklists will (should) always remain
      as complete as you left them.</p><br>
    <p>NOTE: For some of the lists, extraneous words like "plushie" or "figure" have been removed from the checklist
      items to save space and prevent redundancy. Everything should still be obvious as to which figure/plushie/doll you
      are checking.</p>
  </header>

  <main>
    <div class="collection-grid">
      <!-- Original tracker (keeps its IDs for now) -->
      <section id="tracker" class="collection-box">
        <h2>Pokédolls</h2>
        <a href="pokedolls.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>Big Pokédolls</h2>
        <a href="big-pokedolls.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>Poképal Dolls</h2>
        <a href="pokepals.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>Wraps</h2>
        <a href="wraps.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>S1 Streamer Figures</h2>
        <a href="s1-streamers.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>S2 Streamer Figures</h2>
        <a href="s2-streamers.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>Vanilla Mob Plushies</h2>
        <a href="vanilla-plushies.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>Vanilla Mob Figures</h2>
        <a href="vanilla-figures.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>Custom Survival Plushies</h2>
        <a href="survival-plushies.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>Alien Plushies</h2>
        <a href="alien-plushies.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>Adorable Summer Plushies</h2>
        <a href="adorable-summer-plushies.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>Cat Head Plushies</h2>
        <a href="cat-head-plushies.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>Christmas Plushies</h2>
        <a href="christmas-plushies.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>Dino Plushies</h2>
        <a href="dino-plushies.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>

      <section id="tracker" class="collection-box">
        <h2>DBZ Plushies</h2>
        <a href="dbz-plushies.html" class="collection-button">
          <p>Click to view</p>
        </a>
      </section>
    </div>
  </main>

  <div id="checklist-export-import" style="text-align: center; margin-top: 2em;">
    <button onclick="exportChecklistData()">Export Checklist</button>
    <input type="file" id="importFileInput" accept=".json" style="margin-left: 1em;" />
    <button onclick="importChecklistData()">Import Checklist</button>
  </div>

  <footer>
    <p>Built with ❤️ for Mythical Cobblemon</p>
  </footer>

  <script src="js/script.js"></script>
  <script>
    // ✅ Export function must be in global scope
    function exportChecklistData() {
      const data = {};

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        data[key] = value;
      }

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "mythical-checklist.json";
      a.click();

      URL.revokeObjectURL(url);
    }

    // ✅ Import function must also be global
    function importChecklistData() {
      const input = document.getElementById("importFileInput");
      const file = input.files[0];

      if (!file) {
        alert("Please select a JSON file first.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const data = JSON.parse(event.target.result);
          for (const [key, value] of Object.entries(data)) {
            localStorage.setItem(key, value);
          }
          alert("Checklist imported successfully! The page will now refresh.");
          location.reload();
        } catch (e) {
          alert("Failed to import checklist. Make sure you're using a valid JSON file.");
        }
      };
      reader.readAsText(file);
    }

    // ✅ Leave this inside DOMContentLoaded for safe DOM access
    document.addEventListener("DOMContentLoaded", () => {
      const sectionConfigs = {
        "Pokédolls": [
          "wave-1-", "wave-2-", "wave-3-", "wave-4-", "wave-5-",
          "wave-6-", "wave-7-", "wave-8-", "wave-9-", "wave-10-",
          "wave-11-", "wave-12-", "wave-13-", "wave-14-", "wave-15-",
          "wave-16-", "wave-17-", "wave-1-W1-gilded-", "wave-3-W3-halloween-"
        ],
        "Big Pokédolls": ["big-pokedolls-"],
        "Vanilla Mob Plushies": ["vanilla-plushies-"],
        "Poképal Dolls": ["pokepal-dolls-"],
        "Wraps": ["wraps-"],
        "S1 Streamer Figures": ["s1streamers-"],
        "S2 Streamer Figures": ["s2streamers-"],
        "Vanilla Mob Figures": ["vanilla-figures-"],
        "Custom Survival Plushies": ["survival-plushies-"],
        "Alien Plushies": ["alien-plushies-"],
        "Adorable Summer Plushies": ["adorable-summer-"],
        "Cat Head Plushies": ["cat-heads-"],
        "Christmas Plushies": ["xmas-plushies-"],
        "Dino Plushies": ["dino-plushies-"],
        "DBZ Plushies": ["dbz-plushies-"]
      };

      function countLocalStorageMatches(prefixes) {
        let total = 0;
        let checked = 0;

        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (prefixes.some(prefix => key.startsWith(prefix)) && !key.endsWith("-toggle")) {
            total++;
            if (localStorage.getItem(key) === "true") {
              checked++;
            }
          }
        }

        const percent = total > 0 ? (checked / total) * 100 : 0;
        return { total, checked, percent };
      }

      document.querySelectorAll("section.collection-box").forEach(section => {
        const title = section.querySelector("h2")?.textContent;
        const prefixes = sectionConfigs[title];
        if (!prefixes) return;

        const { total, checked, percent } = countLocalStorageMatches(prefixes);

        const summary = document.createElement("p");
        summary.className = "section-summary";
        summary.textContent = `${checked}/${total}`;

        const barContainer = document.createElement("div");
        barContainer.className = "progress-container";

        const barFill = document.createElement("div");
        barFill.className = "progress-fill";
        barFill.style.width = `${percent}%`;

        barContainer.appendChild(barFill);

        const button = section.querySelector(".collection-button");
        section.insertBefore(summary, button);
        section.insertBefore(barContainer, button);
      });
    });
  </script>

</body>

</html>